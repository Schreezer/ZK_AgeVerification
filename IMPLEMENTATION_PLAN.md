# ZK-ID Age Gate Backend Implementation Plan

This document outlines the plan for implementing the backend systems for the "ZK-ID Age Gate" project simulation. This includes a Mock Government Identity System and a Mock Service Provider (e.g., Social Media) backend.

## I. Technology Stack

*   **Language:** Node.js
*   **Framework:** Express.js (for building REST APIs)
*   **Cryptography:**
    *   `noble-curves` (specifically `secp256k1`) for ECDSA signing on the Government backend.
    *   `snarkjs` for ZKP verification on the Service Provider backend.
*   **Data Storage:** Simple in-memory storage or flat files for simulation purposes (e.g., storing the government's key pair).

## II. Project Structure

```
/Users/chirag13/development/cybersec/project/
├── government-backend/
│   ├── src/
│   │   ├── index.js         # Main server file
│   │   ├── api.js           # API route definitions
│   │   └── crypto.js        # Signing logic, key management
│   ├── package.json
│   └── .env                 # To store private key (for simulation)
├── service-provider-backend/
│   ├── src/
│   │   ├── index.js         # Main server file
│   │   ├── api.js           # API route definitions
│   │   └── verification.js  # ZKP verification logic
│   ├── package.json
│   ├── verifier_key.json    # ZKP verification key (from Circom - Placeholder/Provided later)
│   └── .env                 # Optional config
├── shared/                  # (Optional) Common types or utilities
└── IMPLEMENTATION_PLAN.md   # This file
```

## III. Government Identity System Backend Plan

*   **Goal:** Simulate a government authority that issues signed credentials containing minimal age-related information (e.g., Date of Birth).
*   **Key Management:**
    *   Generate an ECDSA (secp256k1) key pair (private/public key).
    *   Store the private key securely in `government-backend/.env`.
    *   Expose an endpoint to retrieve the public key.
*   **API Endpoints:**
    *   `GET /public-key`: Returns the government's public key (hex-encoded).
    *   `POST /request-credential`:
        *   Accepts minimal user identification (simulated, e.g., `{ userId: 'user123' }`).
        *   Looks up/generates a simulated Date of Birth (DoB) for the user (e.g., based on `userId`).
        *   Creates a credential object (e.g., `{ dob: 'YYYY-MM-DD', issuedAt: timestamp }`).
        *   Signs the SHA256 hash of the credential object using the government's private key.
        *   Returns the credential object and its signature (hex-encoded).

## IV. Service Provider (Social Media) Backend Plan

*   **Goal:** Simulate a service that needs to verify if a user meets an age requirement (e.g., 18+) without learning their exact DoB.
*   **ZKP Artifacts:** Requires the `verification_key.json` generated by `snarkjs` after the Circom circuit compilation and trusted setup. This file will be placed in `service-provider-backend/`.
*   **API Endpoints:**
    *   `GET /request-age-verification`:
        *   Generates a unique, random nonce (e.g., a large random number or UUID).
        *   Returns this nonce to the User Agent.
    *   `POST /verify-proof`:
        *   Accepts the ZK proof (`proof`) and the public inputs (`publicSignals`) from the User Agent. Public inputs typically include:
            *   The nonce previously issued.
            *   The minimum age threshold (e.g., `18`).
            *   A commitment to the government's public key (e.g., its hash) to ensure the proof relates to the correct issuer.
            *   A hash of the credential's non-private parts (like `issuedAt`) if needed by the circuit.
        *   Uses `snarkjs.groth16.verify()` with the `verification_key.json`, `publicSignals`, and `proof`.
        *   Returns `{ verified: true }` or `{ verified: false }` based on the verification result.

## V. Interaction Flow (Backend Perspective)

1.  **User Agent -> Service Backend (`/request-age-verification`):** Gets a unique nonce.
2.  **User Agent -> Government Backend (`/request-credential`):** Authenticates (simulated) and receives a signed credential (e.g., `{ dob: ..., issuedAt: ... }` + signature).
3.  **(User Agent - Local):** Generates ZK proof using the signed credential, the nonce, the age threshold, and the government public key context. This involves the Circom circuit.
4.  **User Agent -> Service Backend (`/verify-proof`):** Submits the generated proof and public inputs.
5.  **Service Backend:** Verifies the proof using `snarkjs` and the `verification_key.json`. Responds to the User Agent with the verification status.

## VI. Implementation Steps (Following this Plan)

1.  Create the directory structure (`government-backend`, `service-provider-backend`).
2.  Initialize `npm` projects in both backend directories (`npm init -y`).
3.  Install dependencies (`express`, `dotenv`, `noble-curves`, `sha256`, `cors` for government; `express`, `snarkjs`, `cors` for service provider).
4.  Implement the Government Backend server (`index.js`, `api.js`, `crypto.js`).
5.  Implement the Service Provider Backend server (`index.js`, `api.js`, `verification.js`).
6.  Create placeholder `verifier_key.json`.
7.  Add basic `.env` files.
